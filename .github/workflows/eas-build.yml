name: EAS Build Android

on:
  push:
    branches: [main, master]
  workflow_dispatch: # Allow manual trigger from GitHub UI

jobs:
  build:
    name: Build Android APK
    runs-on: ubuntu-latest

    steps:
      - name: 🏗 Checkout code
        uses: actions/checkout@v4

      - name: 🏗 Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: npm

      - name: 🏗 Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: 📦 Install dependencies
        run: npm ci

      - name: 🚀 Build on EAS
        run: |
          eas build --platform android --profile preview --non-interactive --auto-submit-with-profile=preview || true

      - name: 📥 Download artifact
        id: download
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');

            // Get the latest build
            const builds = execSync('eas build:list --platform=android --limit=1 --json', {
              encoding: 'utf-8'
            });

            const buildData = JSON.parse(builds);
            if (buildData.length > 0 && buildData[0].artifacts?.buildUrl) {
              core.setOutput('download_url', buildData[0].artifacts.buildUrl);
              core.setOutput('build_id', buildData[0].id);
            }

      - name: 📱 Build Info
        run: |
          echo "✅ Build completed!"
          echo "📥 Download URL: ${{ steps.download.outputs.download_url }}"
          echo "🔗 Build Details: https://expo.dev/accounts/alihasan_123/projects/NUX/builds/${{ steps.download.outputs.build_id }}"

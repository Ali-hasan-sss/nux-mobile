name: Build Android APK (Local)

on:
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      build_type:
        description: "Build Type"
        required: true
        default: "release"
        type: choice
        options:
          - release
          - debug

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest

    steps:
      - name: 🏗 Checkout code
        uses: actions/checkout@v4

      - name: 🏗 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: 🏗 Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: 📦 Install dependencies
        run: npm ci

      - name: 🔨 Generate native code with Expo Prebuild
        run: npx expo prebuild --platform android --clean

      - name: 📝 Setup release keystore
        if: ${{ github.event.inputs.build_type == 'release' }}
        run: |
          cd android/app
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > release.keystore

      - name: 🔨 Build APK (Debug)
        if: ${{ github.event.inputs.build_type == 'debug' || github.event.inputs.build_type == '' }}
        run: |
          cd android
          chmod +x ./gradlew
          ./gradlew assembleDebug --no-daemon
        env:
          EXPO_NO_DOTENV: 1

      - name: 🔨 Build APK (Release)
        if: ${{ github.event.inputs.build_type == 'release' }}
        run: |
          cd android
          chmod +x ./gradlew
          ./gradlew assembleRelease --no-daemon \
            -Pandroid.injected.signing.store.file=app/release.keystore \
            -Pandroid.injected.signing.store.password=${{ secrets.KEYSTORE_PASSWORD }} \
            -Pandroid.injected.signing.key.alias=${{ secrets.KEY_ALIAS }} \
            -Pandroid.injected.signing.key.password=${{ secrets.KEY_PASSWORD }}
        env:
          EXPO_NO_DOTENV: 1

      - name: 📦 Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ github.event.inputs.build_type || 'debug' }}.apk
          path: |
            android/app/build/outputs/apk/debug/*.apk
            android/app/build/outputs/apk/release/*.apk
          retention-days: 30

      - name: ✅ Build complete
        run: |
          echo "🎉 APK built successfully!"
          echo "📥 Download your APK from the Actions artifacts tab"
          ls -lh android/app/build/outputs/apk/*/*.apk
